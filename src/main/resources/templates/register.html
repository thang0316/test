<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêƒÉng k√Ω FoodFast</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>

    <style>
        body {
            background: linear-gradient(135deg, #00b894, #00cec9);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: "Segoe UI", sans-serif;
        }

        .register-card {
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
            border-radius: 14px;
            background: #fff;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }

        #restaurantMap {
            height: 300px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .autocomplete-suggestions {
            position: absolute;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .autocomplete-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .autocomplete-suggestion:hover {
            background-color: #f0f0f0;
        }

        .btn-register {
            background-color: #00b894;
            color: white;
            font-weight: 600;
        }

        .btn-register:hover {
            background-color: #009e80;
        }

        #error-msg, #success-msg {
            text-align: center;
            font-size: 14px;
            margin-top: 8px;
        }

        #error-msg { color: red; }
        #success-msg { color: green; }
    </style>
</head>

<body>

<div class="register-card">

    <h3 class="text-center mb-3">üìù ƒêƒÉng k√Ω t√†i kho·∫£n</h3>

    <form onsubmit="event.preventDefault(); registerUser();">

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">H·ªç</label>
                <input type="text" id="firstName" class="form-control" required>
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">T√™n</label>
                <input type="text" id="lastName" class="form-control" required>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="email" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="text" id="phone" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">T√™n ƒëƒÉng nh·∫≠p</label>
            <input type="text" id="username" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">M·∫≠t kh·∫©u</label>
            <input type="password" id="password" class="form-control" required minlength="6">
        </div>

        <div class="mb-3">
            <label class="form-label">Ch·ªçn lo·∫°i t√†i kho·∫£n</label>
            <select id="role" class="form-select" onchange="toggleRestaurantInfo()">
                <option value="CUSTOMER">Kh√°ch h√†ng</option>
                <option value="RESTAURANT">Ch·ªß nh√† h√†ng</option>
            </select>
        </div>

        <!-- Form nh√† h√†ng (·∫©n m·∫∑c ƒë·ªãnh) -->
        <div id="restaurantInfo" style="display: none;">
            <div class="mb-3">
                <label class="form-label">T√™n nh√† h√†ng <span class="text-danger">*</span></label>
                <input type="text" id="restaurantName" class="form-control" placeholder="Nh·∫≠p t√™n nh√† h√†ng">
            </div>
            
            <div class="mb-3">
                <label class="form-label">ƒê·ªãa ch·ªâ nh√† h√†ng</label>
                <div style="position: relative;">
                    <input type="text" id="restaurantAddress" class="form-control" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ ho·∫∑c ch·ªçn tr√™n b·∫£n ƒë·ªì">
                    <div id="restaurantAddressSuggestions" class="autocomplete-suggestions" style="display: none;"></div>
                </div>
            </div>

            <div class="mb-3">
                <label class="form-label">V·ªã tr√≠ tr√™n b·∫£n ƒë·ªì <span class="text-danger">*</span></label>
                <small class="text-muted d-block mb-2">Click tr√™n b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn v·ªã tr√≠ nh√† h√†ng</small>
                <div id="restaurantMap"></div>
                <input type="hidden" id="restaurantLat">
                <input type="hidden" id="restaurantLng">
            </div>
        </div>

        <button type="submit" class="btn btn-register w-100">T·∫°o t√†i kho·∫£n</button>
    </form>

    <div id="error-msg"></div>
    <div id="success-msg"></div>

    <p class="mt-3 text-center">
        ƒê√£ c√≥ t√†i kho·∫£n?
        <a href="/login" class="fw-bold">ƒêƒÉng nh·∫≠p ngay</a>
    </p>
</div>


<script>
    let restaurantMap = null;
    let restaurantMarker = null;
    let searchTimeout = null;

    // Geocoding: T√¨m ki·∫øm ƒë·ªãa ch·ªâ -> to·∫° ƒë·ªô
    async function searchAddress(query, suggestionsDiv, latInput, lngInput, map, markerRef) {
        if (query.length < 3) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
            const results = await response.json();

            if (results.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            suggestionsDiv.innerHTML = results.map(r => 
                `<div class="autocomplete-suggestion" data-lat="${r.lat}" data-lon="${r.lon}" data-name="${r.display_name}">
                    ${r.display_name}
                </div>`
            ).join('');
            suggestionsDiv.style.display = 'block';

            // Handle click on suggestion
            suggestionsDiv.querySelectorAll('.autocomplete-suggestion').forEach(item => {
                item.addEventListener('click', function() {
                    const lat = parseFloat(this.dataset.lat);
                    const lon = parseFloat(this.dataset.lon);
                    const name = this.dataset.name;

                    document.getElementById(latInput).value = lat.toFixed(6);
                    document.getElementById(lngInput).value = lon.toFixed(6);
                    document.getElementById(latInput.replace('Lat', 'Address')).value = name;
                    suggestionsDiv.style.display = 'none';

                    // Move map to location
                    map.setView([lat, lon], 15);
                    
                    // Remove old marker
                    if (window[markerRef]) {
                        map.removeLayer(window[markerRef]);
                    }
                    
                    // Add new marker
                    window[markerRef] = L.marker([lat, lon]).addTo(map)
                        .bindPopup(`<b>${name}</b><br>Vƒ© ƒë·ªô: ${lat.toFixed(6)}<br>Kinh ƒë·ªô: ${lon.toFixed(6)}`).openPopup();
                });
            });
        } catch (error) {
            console.error('Geocoding error:', error);
        }
    }

    // Reverse Geocoding: To·∫° ƒë·ªô -> ƒë·ªãa ch·ªâ
    async function reverseGeocode(lat, lon, addressInput) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            const result = await response.json();
            
            if (result.display_name) {
                document.getElementById(addressInput).value = result.display_name;
            }
        } catch (error) {
            console.error('Reverse geocoding error:', error);
        }
    }

    // Toggle hi·ªÉn th·ªã form nh√† h√†ng
    function toggleRestaurantInfo() {
        const role = document.getElementById("role").value;
        const restaurantInfo = document.getElementById("restaurantInfo");
        
        if (role === "RESTAURANT") {
            restaurantInfo.style.display = "block";
            // Initialize map when shown
            setTimeout(() => initRestaurantMap(), 100);
        } else {
            restaurantInfo.style.display = "none";
        }
    }

    // Initialize map for restaurant location
    function initRestaurantMap() {
        if (restaurantMap) return; // Already initialized
        
        restaurantMap = L.map('restaurantMap').setView([21.0285, 105.8542], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
        }).addTo(restaurantMap);

        // Address input autocomplete
        const addressInput = document.getElementById('restaurantAddress');
        addressInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchAddress(this.value, 
                    document.getElementById('restaurantAddressSuggestions'),
                    'restaurantLat', 'restaurantLng', restaurantMap, 'restaurantMarker');
            }, 500);
        });

        // Click to select location
        restaurantMap.on('click', async function(e) {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            
            document.getElementById('restaurantLat').value = lat.toFixed(6);
            document.getElementById('restaurantLng').value = lng.toFixed(6);
            
            // Get address from coordinates
            await reverseGeocode(lat, lng, 'restaurantAddress');
            
            // Remove old marker
            if (restaurantMarker) {
                restaurantMap.removeLayer(restaurantMarker);
            }
            
            // Add new marker with coordinates in popup
            restaurantMarker = L.marker([lat, lng]).addTo(restaurantMap)
                .bindPopup(`<b>V·ªã tr√≠ nh√† h√†ng</b><br>Vƒ© ƒë·ªô: ${lat.toFixed(6)}<br>Kinh ƒë·ªô: ${lng.toFixed(6)}`).openPopup();
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#restaurantAddress')) {
                document.getElementById('restaurantAddressSuggestions').style.display = 'none';
            }
        });
    }

    async function registerUser() {

        const selectedRole = document.getElementById("role").value;

        // üî• Map role ƒë√∫ng theo database
        let roleId = 2; // CUSTOMER m·∫∑c ƒë·ªãnh
        if (selectedRole === "RESTAURANT") roleId = 3;

        const data = {
            firstName: document.getElementById("firstName").value.trim(),
            lastName: document.getElementById("lastName").value.trim(),
            email: document.getElementById("email").value.trim(),
            phone: document.getElementById("phone").value.trim(),
            username: document.getElementById("username").value.trim(),
            password: document.getElementById("password").value.trim(),
            roleId: roleId
        };

        // N·∫øu l√† nh√† h√†ng, th√™m th√¥ng tin nh√† h√†ng
        if (selectedRole === "RESTAURANT") {
            data.restaurantName = document.getElementById("restaurantName").value.trim();
            data.restaurantAddress = document.getElementById("restaurantAddress").value.trim();
            data.restaurantLatitude = parseFloat(document.getElementById("restaurantLat").value);
            data.restaurantLongitude = parseFloat(document.getElementById("restaurantLng").value);
            
            // Validate t√™n nh√† h√†ng
            if (!data.restaurantName) {
                document.getElementById("error-msg").textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n nh√† h√†ng!";
                return;
            }
            
            // Validate t·ªça ƒë·ªô
            if (!data.restaurantLatitude || !data.restaurantLongitude) {
                document.getElementById("error-msg").textContent = "‚ö†Ô∏è Vui l√≤ng ch·ªçn v·ªã tr√≠ tr√™n b·∫£n ƒë·ªì!";
                return;
            }
        }

        const errorMsg = document.getElementById("error-msg");
        const successMsg = document.getElementById("success-msg");
        errorMsg.textContent = "";
        successMsg.textContent = "";

        try {
            const response = await fetch("/api/users", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                errorMsg.textContent = "‚ö†Ô∏è Username ho·∫∑c Email ƒë√£ t·ªìn t·∫°i!";
                return;
            }

            successMsg.textContent = "üéâ T·∫°o t√†i kho·∫£n th√†nh c√¥ng! Chuy·ªÉn h∆∞·ªõng...";

            setTimeout(() => window.location.href = "/login", 1200);

        } catch (err) {
            errorMsg.textContent = "‚ùå L·ªói k·∫øt n·ªëi server!";
        }
    }
</script>


</body>
</html>
