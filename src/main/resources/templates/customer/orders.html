<h3>ƒê∆°n h√†ng c·ªßa b·∫°n</h3>

<div id="ordersBox">ƒêang t·∫£i...</div>

<!-- Modal chi ti·∫øt ƒë∆°n h√†ng -->
<div id="orderDetailModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi ti·∫øt ƒë∆°n h√†ng #<span id="orderDetailId"></span></h5>
                <button type="button" class="btn-close" onclick="closeModal()"></button>
            </div>
            <div class="modal-body">
                <div id="detailContent">ƒêang t·∫£i...</div>
            </div>
        </div>
    </div>
</div>

<!-- Modal tracking (b·∫£n ƒë·ªì giao h√†ng) -->
<div id="trackingModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Theo d√µi giao h√†ng</h5>
                <button type="button" class="btn-close" onclick="closeTrackingModal()"></button>
            </div>
            <div class="modal-body">
                <div id="trackingMap" style="height: 400px; border-radius: 8px; margin-bottom: 15px;"></div>
                <div id="trackingInfo"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal feedback/ƒë√°nh gi√° -->
<div id="feedbackModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ƒê√°nh gi√° ƒë∆°n h√†ng</h5>
                <button type="button" class="btn-close" onclick="closeFeedbackModal()"></button>
            </div>
            <div class="modal-body">
                <div id="feedbackContent">ƒêang t·∫£i...</div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
    /* ===============================
                LOAD USER FORMAT C≈®
    =============================== */
    function getUser(){
        return JSON.parse(localStorage.getItem("user") || "{}");
    }

    /* ===============================
         D·ªäCH TR·∫†NG TH√ÅI SANG TI·∫æNG VI·ªÜT
    =============================== */
    function translateStatus(status) {
        const statusMap = {
            'PENDING': 'Ch·ªù x√°c nh·∫≠n',
            'CONFIRMED': 'ƒê√£ x√°c nh·∫≠n',
            'DELIVERING': 'ƒêang giao',
            'COMPLETED': 'Ho√†n th√†nh',
            'CANCELED': 'ƒê√£ h·ªßy'
        };
        return statusMap[status] || status;
    }    /* ===============================
                LOAD ORDERS
    =============================== */
    async function loadOrders(){
        let user = getUser();

        if(!user.id){
            ordersBox.innerHTML = "<p class='text-danger'>Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ng∆∞·ªùi d√πng!</p>";
            return;
        }

        const r = await fetch(`/api/orders/user/${user.id}`);
        const list = await r.json();

        if(!Array.isArray(list) || list.length === 0){
            ordersBox.innerHTML = "<p class='text-muted'>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>";
            return;
        }

        let html = "";

        list.forEach(o=>{
            let date = o.createdAt ? new Date(o.createdAt).toLocaleString("vi-VN") : "Kh√¥ng r√µ";
            let cancelBtn = o.status === 'PENDING' ? `<button class="btn btn-danger btn-sm" onclick="if(confirm('H·ªßy ƒë∆°n h√†ng?')) cancelOrder(${o.id})">H·ªßy ƒë∆°n</button>` : '';

            html += `
        <div class="border rounded p-3 mb-3">
            <h5>ƒê∆°n #${o.id}</h5>
            <p>Tr·∫°ng th√°i:
                <b class="text-primary">${translateStatus(o.status)}</b>
            </p>
            <p>T·ªïng ti·ªÅn:
                <b class="text-danger">${o.totalAmount.toLocaleString()}ƒë</b>
            </p>
            <p>Ng√†y t·∫°o: ${date}</p>
            <button class="btn btn-info btn-sm" onclick="viewOrderDetail(${o.id})">Chi ti·∫øt</button>
            ${cancelBtn}
        </div>`;
        });

        ordersBox.innerHTML = html;
    }

    loadOrders();

    /* ===============================
         H·ª¶Y ƒê∆†N H√ÄNG
    =============================== */
    async function cancelOrder(orderId){
        try {
            const r = await fetch(`/api/orders/${orderId}/status?status=CANCELED`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'}
            });
            
            if(!r.ok){
                alert("Kh√¥ng th·ªÉ h·ªßy ƒë∆°n h√†ng!");
                return;
            }
            
            alert("ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c h·ªßy!");
            loadOrders();
        } catch(e){
            alert("L·ªói: " + e.message);
        }
    }

    /* ===============================
         XEM CHI TI·∫æT ƒê∆†N H√ÄNG
    =============================== */
    async function viewOrderDetail(orderId){
        try {
            const r = await fetch(`/api/orders/${orderId}`);
            const order = await r.json();
            
            // L·∫•y th√¥ng tin payment
            const paymentR = await fetch(`/api/payments/order/${orderId}`);
            const payments = await paymentR.json();
            const completedPayment = payments.find(p => p.status === 'COMPLETED');
            const pendingPayment = payments.find(p => p.status === 'PENDING');
            
            // D·ªãch tr·∫°ng th√°i thanh to√°n
            let paymentStatusVi = completedPayment ? " ƒê√£ thanh to√°n" : "‚è≥ Ch∆∞a thanh to√°n";
            let paymentStatusClass = completedPayment ? "bg-success" : "bg-warning";
            
            // N·∫øu ƒë∆°n b·ªã h·ªßy v√† ƒë√£ thanh to√°n, hi·ªÉn th·ªã ho√†n ti·ªÅn
            if(order.status === 'CANCELED' && completedPayment){
                paymentStatusVi = "ƒê√£ ho√†n ti·ªÅn";
                paymentStatusClass = "bg-info";
            }
            
            document.getElementById('orderDetailId').textContent = orderId;
            
            let itemsHtml = "";
            if(order.items && order.items.length > 0){
                order.items.forEach(item => {
                    itemsHtml += `
                    <tr>
                        <td>${item.menuItem?.name || "Kh√¥ng r√µ"}</td>
                        <td>${item.quantity}</td>
                        <td>${item.price.toLocaleString()}ƒë</td>
                        <td>${(item.quantity * item.price).toLocaleString()}ƒë</td>
                    </tr>`;
                });
            } else {
                itemsHtml = "<tr><td colspan='4' class='text-center text-muted'>Kh√¥ng c√≥ m√≥n ƒÉn</td></tr>";
            }
            
            // Action buttons
            let actionBtnHtml = "";
            let trackingBtn = order.status === 'DELIVERING' ? `<button class="btn btn-info btn-sm" onclick="openTracking(${orderId})">üìç Theo d√µi giao h√†ng</button>` : '';
            
            if(!completedPayment){
                // Ch∆∞a thanh to√°n: hi·ªÉn th·ªã n√∫t Thanh to√°n
                actionBtnHtml = `
                    <div class="mt-3">
                        <button class="btn btn-success" onclick="payOrder(${orderId})">Thanh to√°n</button>
                        ${trackingBtn}
                    </div>`;
            } else {
                // ƒê√£ thanh to√°n: hi·ªÉn th·ªã b·∫£ng l·ªãch s·ª≠ thanh to√°n th√†nh c√¥ng + n√∫t ƒë√°nh gi√°
                let completedDate = new Date(completedPayment.completedAt).toLocaleString("vi-VN");
                
                let paymentHistoryHtml = `
                    <table class="table table-sm table-bordered mt-3">
                        <thead>
                            <tr>
                                <th>Th·ªùi gian t·∫°o</th>
                                <th>S·ªë ti·ªÅn</th>
                                <th>Ph∆∞∆°ng th·ª©c</th>
                                <th>M√£ giao d·ªãch</th>
                                <th>Ng√¢n h√†ng</th>
                                <th>Th·ªùi gian ho√†n th√†nh</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>${new Date(completedPayment.createdAt).toLocaleString("vi-VN")}</td>
                                <td>${completedPayment.amount.toLocaleString()}ƒë</td>
                                <td>${completedPayment.method}</td>
                                <td>${completedPayment.transactionId || "N/A"}</td>
                                <td>${completedPayment.bankCode || "N/A"}</td>
                                <td>${completedDate}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="d-flex gap-2 mt-2">
                        ${trackingBtn}
                        ${order.status === 'COMPLETED' ? `<button id="reviewBtn_${orderId}" class="btn btn-warning btn-sm" onclick="openFeedbackForm(${orderId})">ƒê√°nh gi√°</button>` : `<p class="text-muted">Ch·ªâ c√≥ th·ªÉ ƒë√°nh gi√° khi ƒë∆°n h√†ng ho√†n th√†nh</p>`}
                    </div>
                `;
                
                actionBtnHtml = `
                    <div class="mt-3">
                        <p><strong>L·ªãch s·ª≠ thanh to√°n:</strong></p>
                        ${paymentHistoryHtml}
                    </div>`;
            }
            
            let detailHtml = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>T√™n kh√°ch:</strong> ${order.customerName}</p>
                        <p><strong>ƒêi·ªán tho·∫°i:</strong> ${order.customerPhone}</p>
                        <p><strong>ƒê·ªãa ch·ªâ:</strong> ${order.customerAddress}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Nh√† h√†ng:</strong> ${order.restaurant?.name || "Kh√¥ng r√µ"}</p>
                        <p><strong>Tr·∫°ng th√°i ƒë∆°n:</strong> <span class="badge bg-primary">${translateStatus(order.status)}</span></p>
                        <p><strong>Thanh to√°n:</strong> <span class="badge ${paymentStatusClass}">${paymentStatusVi}</span></p>
                        <p><strong>Ng√†y t·∫°o:</strong> ${new Date(order.createdAt).toLocaleString("vi-VN")}</p>
                    </div>
                </div>
                
                <h6>Danh s√°ch m√≥n ƒÉn:</h6>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>T√™n m√≥n</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>Gi√°</th>
                            <th>Th√†nh ti·ªÅn</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>
                
                <div class="text-end mb-3">
                    <p><strong>T·ªïng c·ªông:</strong> <span class="text-danger" style="font-size: 18px;">${order.totalAmount.toLocaleString()}ƒë</span></p>
                </div>
                
                ${actionBtnHtml}
            `;
            
            document.getElementById('detailContent').innerHTML = detailHtml;
            // M·ªü modal b·∫±ng c√°ch trigger click
            document.getElementById('orderDetailModal').style.display = 'block';
            document.getElementById('orderDetailModal').classList.add('show');
            document.body.classList.add('modal-open');
            
            // T·∫°o backdrop
            let backdrop = document.querySelector('.modal-backdrop');
            if(!backdrop){
                backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
            }
            
            // Ki·ªÉm tra xem ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c ƒë√°nh gi√° ch∆∞a
            checkOrderReviewed(orderId);
        } catch(e){
            alert("L·ªói: " + e.message);
        }
    }

    // Thanh to√°n ƒë∆°n h√†ng
    async function payOrder(orderId){
        try {
            const r = await fetch(`/api/payments/vnpay/create?orderId=${orderId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            
            if(!r.ok){
                alert("Kh√¥ng th·ªÉ k·∫øt n·ªëi VNPay!");
                return;
            }
            
            const vnpayUrl = await r.text();
            
            if(vnpayUrl && vnpayUrl.startsWith("http")){
                window.location.href = vnpayUrl;
            } else {
                alert("L·ªói: Kh√¥ng th·ªÉ t·∫°o link thanh to√°n!");
            }
        } catch(e){
            alert("L·ªói: " + e.message);
        }
    }

    // ƒê√≥ng modal
    function closeModal(){
        document.getElementById('orderDetailModal').style.display = 'none';
        document.getElementById('orderDetailModal').classList.remove('show');
        document.body.classList.remove('modal-open');
        let backdrop = document.querySelector('.modal-backdrop');
        if(backdrop) backdrop.remove();
    }

    /* ===============================
         THEO D√ïI GIAO H√ÄNG (TRACKING)
    =============================== */
    var trackingMap = null;
    var trackingMarker = null;

    async function openTracking(orderId){
        try {
            // L·∫•y th√¥ng tin delivery
            const delRes = await fetch(`/api/deliveries/order/${orderId}`);
            if(!delRes.ok) {
                alert("Kh√¥ng th·ªÉ l·∫•y th√¥ng tin giao h√†ng!");
                return;
            }
            const delivery = await delRes.json();
            
            if(!delivery.drone?.currentLatitude || !delivery.drone?.currentLongitude){
                alert("V·ªã tr√≠ giao h√†ng ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t!");
                return;
            }

            // Hi·ªÉn th·ªã info
            let infoHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Drone:</strong> ${delivery.drone?.model || "Kh√¥ng r√µ"}</p>
                        <p><strong>Tr·∫°ng th√°i:</strong> <span class="badge bg-primary">${delivery.status}</span></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Vƒ© ƒë·ªô:</strong> ${delivery.drone.currentLatitude.toFixed(6)}</p>
                        <p><strong>Kinh ƒë·ªô:</strong> ${delivery.drone.currentLongitude.toFixed(6)}</p>
                    </div>
                </div>
                ${delivery.startTime ? `<p><strong>B·∫Øt ƒë·∫ßu:</strong> ${new Date(delivery.startTime).toLocaleString("vi-VN")}</p>` : ''}
                ${delivery.endTime ? `<p><strong>K·∫øt th√∫c:</strong> ${new Date(delivery.endTime).toLocaleString("vi-VN")}</p>` : ''}
            `;
            document.getElementById('trackingInfo').innerHTML = infoHtml;

            // Init map
            if(!trackingMap){
                trackingMap = L.map('trackingMap', {
                    center: [delivery.drone.currentLatitude, delivery.drone.currentLongitude],
                    zoom: 15
                });
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(trackingMap);
            } else {
                trackingMap.setView([delivery.drone.currentLatitude, delivery.drone.currentLongitude], 15);
            }

            // Add marker
            if(trackingMarker) trackingMap.removeLayer(trackingMarker);
            trackingMarker = L.marker([delivery.drone.currentLatitude, delivery.drone.currentLongitude], {
                icon: L.icon({
                    iconUrl: 'https://cdn-icons-png.flaticon.com/512/3597/3597911.png',
                    iconSize: [40, 40],
                    popupAnchor: [0, -20]
                })
            }).bindPopup(`<strong>${delivery.drone?.model || "Drone"}</strong><br>V·ªã tr√≠ hi·ªán t·∫°i`).addTo(trackingMap);

            // M·ªü modal
            document.getElementById('trackingModal').style.display = 'block';
            document.getElementById('trackingModal').classList.add('show');
            document.body.classList.add('modal-open');
            
            let backdrop = document.querySelector('.modal-backdrop');
            if(!backdrop){
                backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                document.body.appendChild(backdrop);
            }

            // Refresh map size
            setTimeout(() => { if(trackingMap) trackingMap.invalidateSize(); }, 200);

        } catch(e){
            alert("L·ªói: " + e.message);
        }
    }

    function closeTrackingModal(){
        document.getElementById('trackingModal').style.display = 'none';
        document.getElementById('trackingModal').classList.remove('show');
        document.body.classList.remove('modal-open');
        let backdrop = document.querySelector('.modal-backdrop');
        if(backdrop) backdrop.remove();
    }

    // Ki·ªÉm tra xem ƒë∆°n h√†ng ƒë√£ ƒë∆∞·ª£c ƒë√°nh gi√° ch∆∞a
    async function checkOrderReviewed(orderId){
        try {
            const res = await fetch(`/api/reviews/order/${orderId}`);
            const review = await res.json();
            
            let reviewBtn = document.getElementById(`reviewBtn_${orderId}`);
            if(reviewBtn){
                if(review && review.id){
                    // ƒê√£ review r·ªìi
                    reviewBtn.disabled = true;
                    reviewBtn.innerHTML = "‚úì ƒê√£ ƒë√°nh gi√°";
                    reviewBtn.classList.remove('btn-warning');
                    reviewBtn.classList.add('btn-success');
                } else {
                    // Ch∆∞a review
                    reviewBtn.disabled = false;
                    reviewBtn.innerHTML = "ƒê√°nh gi√°";
                }
            }
        } catch(e){
            console.log("Kh√¥ng th·ªÉ ki·ªÉm tra review:", e);
        }
    }

    // M·ªü form feedback/ƒë√°nh gi√°
    function openFeedbackForm(orderId){
        let user = getUser();
        
        let feedbackHtml = `
            <div>
                <p><strong>ƒê√°nh gi√° nh√† h√†ng n√†y:</strong></p>
                
                <div class="mb-3">
                    <label class="form-label">S·ªë sao <span class="text-danger">*</span></label>
                    <div>
                        <input type="radio" name="rating" value="1" id="r1"> <label for="r1">‚≠ê 1 sao</label><br>
                        <input type="radio" name="rating" value="2" id="r2"> <label for="r2">‚≠ê‚≠ê 2 sao</label><br>
                        <input type="radio" name="rating" value="3" id="r3"> <label for="r3">‚≠ê‚≠ê‚≠ê 3 sao</label><br>
                        <input type="radio" name="rating" value="4" id="r4"> <label for="r4">‚≠ê‚≠ê‚≠ê‚≠ê 4 sao</label><br>
                        <input type="radio" name="rating" value="5" id="r5" checked> <label for="r5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5 sao</label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Nh·∫≠n x√©t (kh√¥ng b·∫Øt bu·ªôc)</label>
                    <textarea id="feedbackComment" class="form-control" rows="3" placeholder="Chia s·∫ª c·∫£m nh·∫≠n c·ªßa b·∫°n..."></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="submitFeedback(${orderId}, '${user.id}')">G·ª≠i ƒë√°nh gi√°</button>
                <button class="btn btn-secondary" onclick="closeFeedbackModal()">H·ªßy</button>
            </div>
        `;
        
        feedbackContent.innerHTML = feedbackHtml;
        feedbackModal.style.display = 'block';
        feedbackModal.classList.add('show');
        document.body.classList.add('modal-open');
        
        // T·∫°o backdrop
        let backdrop = document.querySelector('.modal-backdrop');
        if(!backdrop){
            backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(backdrop);
        }
    }

    // G·ª≠i feedback
    async function submitFeedback(orderId, userId){
        let rating = document.querySelector('input[name="rating"]:checked')?.value;
        let comment = document.getElementById('feedbackComment').value;
        
        if(!rating){
            alert("Vui l√≤ng ch·ªçn s·ªë sao!");
            return;
        }
        
        let payload = {
            userId: userId,
            orderId: orderId,
            rating: parseInt(rating),
            comment: comment || null
        };
        
        try {
            const res = await fetch("/api/reviews", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });
            
            if(!res.ok){
                alert("Kh√¥ng th·ªÉ g·ª≠i ƒë√°nh gi√°!");
                return;
            }
            
            alert("C·∫£m ∆°n ƒë√°nh gi√° c·ªßa b·∫°n!");
            closeFeedbackModal();
            // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t ƒëi·ªÉm nh√† h√†ng
            setTimeout(() => {
                location.reload();
            }, 1000);
        } catch(e){
            alert("L·ªói: " + e.message);
        }
    }

    // ƒê√≥ng feedback modal
    function closeFeedbackModal(){
        feedbackModal.style.display = 'none';
        feedbackModal.classList.remove('show');
        document.body.classList.remove('modal-open');
        let backdrop = document.querySelector('.modal-backdrop');
        if(backdrop) backdrop.remove();
    }
</script>
