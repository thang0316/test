<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>üë§ Qu·∫£n l√Ω Ng∆∞·ªùi d√πng | FoodFast Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>

    <style>
        body { background-color:#f9fafc; color:#212529; font-family:"Segoe UI",sans-serif; padding:2rem; }
        h2 { font-weight:700; color:#0d6efd; display:flex; align-items:center; gap:10px; }
        .subtitle { color:#6c757d; margin-top:-6px; margin-bottom:1.5rem; }
        .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 3px 10px rgba(0,0,0,0.05); }
        .form-control, .form-select { background:#f8f9fa; color:#212529; border:1px solid #ced4da; border-radius:8px; }
        .btn-gradient { background:linear-gradient(90deg,#0d6efd,#00b4d8); border:none; color:white; font-weight:600; transition:all .3s; }
        .btn-gradient:hover { opacity:.9; transform:translateY(-1px); }
        .table thead { background:#0d6efd; color:white; }
        .table tbody tr:hover { background:#eef4ff; cursor:pointer; }
        .badge { padding:0.45rem 0.75rem; border-radius:20px; font-size:0.85rem; }
        .badge-active { background:#28a745; color:white; }
        .badge-disabled { background:#dc3545; color:white; }
        td.editing input { background:#e7f1ff !important; border-color:#0d6efd; width:100%; }
    </style>
</head>

<body>
<div class="container">

    <h2><i class="bi bi-people-fill"></i> Qu·∫£n l√Ω Ng∆∞·ªùi d√πng</h2>
    <p class="subtitle">Th·ªëng k√™, th√™m, ch·ªânh s·ª≠a v√† x√≥a t√†i kho·∫£n ng∆∞·ªùi d√πng trong h·ªá th·ªëng</p>

    <!-- üîπ Th·ªëng k√™ -->
    <div class="row g-3 mb-4">
        <div class="col-md-3"><div class="card p-3 text-center">
            <div class="fs-4 text-primary"><i class="bi bi-people-fill"></i></div>
            <div id="totalUsers" class="fw-bold fs-5">0</div><div class="text-muted">T·ªïng ng∆∞·ªùi d√πng</div>
        </div></div>

        <div class="col-md-3"><div class="card p-3 text-center">
            <div class="fs-4 text-success"><i class="bi bi-shield-lock"></i></div>
            <div id="adminCount" class="fw-bold fs-5">0</div><div class="text-muted">Admin</div>
        </div></div>

        <div class="col-md-3"><div class="card p-3 text-center">
            <div class="fs-4 text-info"><i class="bi bi-shop"></i></div>
            <div id="restaurantCount" class="fw-bold fs-5">0</div><div class="text-muted">Restaurant</div>
        </div></div>

        <div class="col-md-3"><div class="card p-3 text-center">
            <div class="fs-4 text-warning"><i class="bi bi-person"></i></div>
            <div id="customerCount" class="fw-bold fs-5">0</div><div class="text-muted">Customer</div>
        </div></div>
    </div>

    <!-- üîπ Form th√™m -->
    <div class="card p-4 mb-4">
        <h5 class="text-primary mb-3"><i class="bi bi-person-plus"></i> Th√™m ng∆∞·ªùi d√πng m·ªõi</h5>
        <div class="row g-2">
            <div class="col-md-2"><input id="username" class="form-control" placeholder="T√™n ƒëƒÉng nh·∫≠p"></div>
            <div class="col-md-2"><input id="firstName" class="form-control" placeholder="H·ªç"></div>
            <div class="col-md-2"><input id="lastName" class="form-control" placeholder="T√™n"></div>
            <div class="col-md-3"><input id="email" type="email" class="form-control" placeholder="Email"></div>
            <div class="col-md-2"><input id="userPhone" class="form-control" placeholder="SƒêT"></div>
        </div>
        <div class="row g-2 mt-2">
            <div class="col-md-3"><input id="password" type="password" class="form-control" placeholder="M·∫≠t kh·∫©u"></div>
            <div class="col-md-3">
                <select id="roleSelect" class="form-select">
                    <option value="1">ADMIN</option>
                    <option value="2">CUSTOMER</option>
                    <option value="3">RESTAURANT</option>
                </select>
            </div>
            <div class="col-md-2"><button class="btn btn-gradient w-100" onclick="createUser()">Th√™m</button></div>
        </div>
    </div>

    <!-- üîπ T√¨m ki·∫øm -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="bi bi-list-ul text-primary"></i> Danh s√°ch ng∆∞·ªùi d√πng</h5>
        <input id="searchUser" type="text" class="form-control w-25"
               placeholder="üîç T√¨m theo ID, t√™n, email ho·∫∑c SƒêT...">
    </div>

    <!-- üîπ B·∫£ng -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle" id="userTable">
                <thead>
                <tr>
                    <th>ID</th><th>T√™n ƒëƒÉng nh·∫≠p</th><th>H·ªç</th><th>T√™n</th>
                    <th>Email</th><th>SƒêT</th><th>Vai tr√≤</th><th>H√†nh ƒë·ªông</th>
                </tr>
                </thead>
                <tbody><tr><td colspan="9" class="text-center text-muted">ƒêang t·∫£i...</td></tr></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_BASE = "http://localhost:8080/api";
    let users = [];
    let editingCell = null;

    // ==========================
    // Load Users
    // ==========================
    async function loadUsers() {
        const tbody = document.querySelector("#userTable tbody");
        tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">ƒêang t·∫£i...</td></tr>`;
        try {
            const res = await fetch(`${API_BASE}/users`);
            users = await res.json();
            renderUsers(users);
            updateStats();
        } catch {
            tbody.innerHTML = `<tr><td colspan="9">L·ªói t·∫£i danh s√°ch</td></tr>`;
        }
    }

    // ==========================
    // Render Table
    // ==========================
    function renderUsers(list){
        const tbody = document.querySelector("#userTable tbody");
        if (!list.length) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted fst-italic">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
            return;
        }

        tbody.innerHTML = list.map(u => `
            <tr data-id="${u.id}">
                <td>${u.id}</td>
                <td class="editable" data-field="username">${u.username}</td>
                <td class="editable" data-field="firstName">${u.firstName}</td>
                <td class="editable" data-field="lastName">${u.lastName}</td>
                <td class="editable" data-field="email">${u.email}</td>
                <td class="editable" data-field="phone">${u.phone}</td>
                <td class="editable" data-field="roleName">${u.role?.name || "‚Äî"}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${u.id}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `).join("");
    }

    // ==========================
    // Inline Editing
    // ==========================
    document.addEventListener("click", function (e) {
        if (!e.target.classList.contains("editable")) return;

        if (editingCell) finishEditing();

        editingCell = e.target;
        const oldValue = editingCell.textContent.trim();

        const input = document.createElement("input");
        input.type = "text";
        input.value = oldValue;
        input.className = "form-control";
        input.style.minWidth = "100px";

        editingCell.innerHTML = "";
        editingCell.appendChild(input);
        input.focus();

        input.addEventListener("keydown", ev => { if (ev.key === "Enter") finishEditing(); });
        input.addEventListener("blur", finishEditing);
    });

    // ==========================
    // Validate + Send Update
    // ==========================
    function finishEditing() {
        if (!editingCell) return;

        const input = editingCell.querySelector("input");
        if (!input) { editingCell = null; return; }

        const newValue = input.value.trim();
        const row = editingCell.closest("tr");
        const id = row.dataset.id;

        editingCell.textContent = newValue;

        updateUserField(id);

        editingCell = null;
    }

    // ==============================
    // üî• THIS IS THE FIXED VERSION üî•
    // ==============================
    async function updateUserField(id) {
        try {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            const tds = row.querySelectorAll("td");

            let roleName = tds[6].innerText.trim().toUpperCase();
            let roleId = 1;

            if (roleName === "CUSTOMER") roleId = 2;
            if (roleName === "RESTAURANT") roleId = 3;

            const payload = {
                username: tds[1].innerText.trim(),
                firstName: tds[2].innerText.trim(),
                lastName: tds[3].innerText.trim(),
                email: tds[4].innerText.trim(),
                phone: tds[5].innerText.trim(),
                roleId: roleId
            };

            const res = await fetch(`${API_BASE}/users/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw new Error(await res.text());

        } catch (err) {
            alert("‚ùå L·ªói c·∫≠p nh·∫≠t:\n" + err.message);
            loadUsers();
        }
    }

    // ==========================
    // Create User
    // ==========================
    async function createUser() {
        const data = {
            username: username.value,
            firstName: firstName.value,
            lastName: lastName.value,
            email: email.value,
            phone: userPhone.value,
            password: password.value,
            roleId: roleSelect.value
        };

        if (!data.username || !data.email || !data.password)
            return alert("‚ö† Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin");

        try {
            const res = await fetch(`${API_BASE}/users`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(data)
            });

            if (!res.ok) throw new Error(await res.text());
            alert("üéâ Th√™m th√†nh c√¥ng!");
            loadUsers();

        } catch (err) {
            alert("‚ùå L·ªói th√™m ng∆∞·ªùi d√πng!\n" + err.message);
        }
    }

    // ==========================
    // Delete User
    // ==========================
    async function deleteUser(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a?")) return;

        try {
            const res = await fetch(`${API_BASE}/users/${id}`, {
                method: "DELETE"
            });

            if (!res.ok) throw new Error(await res.text());
            loadUsers();

        } catch {
            alert("‚ùå L·ªói khi x√≥a user");
        }
    }

    // ==========================
    // Stats
    // ==========================
    function updateStats(){
        document.getElementById("totalUsers").innerText = users.length;
        document.getElementById("adminCount").innerText = users.filter(u=>u.role?.name==="ADMIN").length;
        document.getElementById("restaurantCount").innerText = users.filter(u=>u.role?.name==="RESTAURANT").length;
        document.getElementById("customerCount").innerText = users.filter(u=>u.role?.name==="CUSTOMER").length;
    }

    // ==========================
    // Search
    // ==========================
    document.getElementById("searchUser").addEventListener("input", e => {
        const kw = e.target.value.toLowerCase();
        const filtered = users.filter(u =>
            [u.id, u.username, u.firstName, u.lastName, u.email, u.phone, u.role?.name]
                .some(x => x?.toString().toLowerCase().includes(kw))
        );
        renderUsers(filtered);
    });

    loadUsers();
</script>

</body>
</html>
