<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üè™ Qu·∫£n l√Ω Nh√† h√†ng | FoodFast Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        body { background-color:#f9fafc; color:#212529; font-family:"Segoe UI",sans-serif; padding:2rem; }
        h2 { font-weight:700; color:#0d6efd; display:flex; align-items:center; gap:10px; }
        .subtitle { color:#6c757d; margin-top:-6px; margin-bottom:1.5rem; }
        .card { background-color:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 3px 10px rgba(0,0,0,0.05); }
        .form-control, .form-select { background-color:#f8f9fa; color:#212529; border:1px solid #ced4da; border-radius:8px; }
        .btn-gradient { background:linear-gradient(90deg,#0d6efd,#00b4d8); border:none; color:white; font-weight:600; transition:all .3s; }
        .btn-gradient:hover { opacity:.9; transform:translateY(-1px); }
        .table thead { background-color:#0d6efd; color:white; }
        .table tbody tr:hover { background-color:#eef4ff; cursor:pointer; }
        .badge-open { background-color:#28a745; color:white; padding:0.4rem 0.7rem; border-radius:20px; white-space:nowrap; }
        .badge-closed { background-color:#dc3545; color:white; padding:0.4rem 0.7rem; border-radius:20px; white-space:nowrap; }
        .table td:nth-child(3) { max-width: 400px; word-wrap: break-word; white-space: normal; }
        .table th:nth-child(7), .table td:nth-child(7) { min-width: 150px; white-space: nowrap; }
    </style>
</head>

<body>
<div class="container">
    <h2><i class="bi bi-shop"></i> Qu·∫£n l√Ω Nh√† h√†ng</h2>
    <p class="subtitle">Th·ªëng k√™, th√™m, ch·ªânh s·ª≠a v√† x√≥a th√¥ng tin nh√† h√†ng trong h·ªá th·ªëng</p>

    <!-- üîπ Th·ªëng k√™ -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card p-3 text-center shadow-sm">
                <div class="text-primary fs-4"><i class="bi bi-shop"></i></div>
                <div class="fw-bold fs-5" id="totalRestaurants">0</div>
                <div class="text-muted">T·ªïng s·ªë nh√† h√†ng</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 text-center shadow-sm">
                <div class="text-success fs-4"><i class="bi bi-check-circle"></i></div>
                <div class="fw-bold fs-5" id="openCount">0</div>
                <div class="text-muted">ƒêang ho·∫°t ƒë·ªông</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 text-center shadow-sm">
                <div class="text-danger fs-4"><i class="bi bi-x-circle"></i></div>
                <div class="fw-bold fs-5" id="closedCount">0</div>
                <div class="text-muted">T·∫°m ng∆∞ng ho·∫°t ƒë·ªông</div>
            </div>
        </div>
    </div>

    <!-- üîπ Form th√™m nh√† h√†ng -->
    <div class="card p-4 mb-4">
        <h5 class="text-primary mb-3"><i class="bi bi-plus-circle"></i> Th√™m nh√† h√†ng m·ªõi</h5>
        <div class="row g-2">
            <div class="col-md-3"><input id="name" class="form-control" placeholder="T√™n nh√† h√†ng"></div>
            <div class="col-md-3"><input id="address" class="form-control" placeholder="ƒê·ªãa ch·ªâ"></div>
            <div class="col-md-2"><input id="phone" class="form-control" placeholder="S·ªë ƒëi·ªán tho·∫°i"></div>
            <div class="col-md-3">
                <select id="ownerSelect" class="form-select">
                    <option disabled selected>ƒêang t·∫£i danh s√°ch ng∆∞·ªùi d√πng...</option>
                </select>
            </div>
        </div>
        <div class="row g-2 mt-2">
            <div class="col-md-3">
                <select id="status" class="form-select">
                    <option value="OPEN">ƒêang ho·∫°t ƒë·ªông</option>
                    <option value="CLOSED">T·∫°m ng∆∞ng</option>
                </select>
            </div>
            <div class="col-md-2">
                <button class="btn btn-gradient w-100" onclick="createRestaurant()">Th√™m</button>
            </div>
        </div>
    </div>

    <!-- üîπ Thanh t√¨m ki·∫øm v√† l·ªçc -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center gap-3">
            <h5 class="mb-0"><i class="bi bi-list-ul text-primary"></i> Danh s√°ch nh√† h√†ng</h5>
            <select id="filterSelect" class="form-select form-select-sm" style="width:220px" onchange="applyFilter()">
                <option value="ALL">üîÑ T·∫•t c·∫£ nh√† h√†ng</option>
                <option value="MAX">üèÜ Nhi·ªÅu ƒë∆°n nh·∫•t</option>
                <option value="MIN">üê¢ √çt ƒë∆°n nh·∫•t</option>
            </select>
        </div>
        <input id="searchInput" type="text" class="form-control w-25" placeholder="üîç T√¨m theo ID, t√™n ho·∫∑c ƒë·ªãa ch·ªâ...">
    </div>

    <!-- üîπ B·∫£ng -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle" id="restaurantTable">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>T√™n nh√† h√†ng</th>
                    <th>ƒê·ªãa ch·ªâ</th>
                    <th>SƒêT</th>
                    <th>Ch·ªß s·ªü h·ªØu</th>
                    <th>T·ªïng ƒë∆°n</th>
                    <th>Tr·∫°ng th√°i</th>
                </tr>
                </thead>
                <tbody>
                <tr><td colspan="7" class="text-center text-muted fst-italic">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_BASE = window.apiBase || (window.location.origin + "/api");
    let restaurants = [];
    let users = [];

    async function loadUsers() {
        const select = document.getElementById("ownerSelect");
        try {
            const res = await fetch(`${API_BASE}/users`);
            users = await res.json();
            const options = users
                .filter(u => u.role?.name?.toLowerCase().includes("restaurant") || u.role?.name?.toLowerCase().includes("owner"))
                .map(u => `<option value="${u.id}">${u.username} (${u.id})</option>`)
                .join("");
            select.innerHTML = options || `<option disabled>Kh√¥ng c√≥ ng∆∞·ªùi d√πng ph√π h·ª£p</option>`;
        } catch {
            select.innerHTML = `<option disabled>L·ªói t·∫£i danh s√°ch</option>`;
        }
    }

    async function loadRestaurants() {
        const tbody = document.querySelector("#restaurantTable tbody");
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">ƒêang t·∫£i...</td></tr>`;
        try {
            const res = await fetch(`${API_BASE}/restaurants`);
            restaurants = await res.json();

            await Promise.all(
                restaurants.map(async r => {
                    try {
                        const orderRes = await fetch(`${API_BASE}/orders/restaurant/${encodeURIComponent(r.id)}/count`);
                        const count = orderRes.ok ? await orderRes.text() : 0;
                        r.totalOrders = parseInt(count) || 0;
                    } catch { r.totalOrders = 0; }
                })
            );

            renderRestaurants(restaurants);
            updateStats();

        } catch {
            tbody.innerHTML = `<tr><td colspan="7" class="text-danger text-center">L·ªói t·∫£i danh s√°ch</td></tr>`;
        }
    }

    function renderRestaurants(list) {
        const tbody = document.querySelector("#restaurantTable tbody");
        if (!list.length) {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted fst-italic">Kh√¥ng c√≥ nh√† h√†ng n√†o</td></tr>`;
            return;
        }
        tbody.innerHTML = list.map(r => `
            <tr>
                <td>${r.id}</td>
                <td>${r.name}</td>
                <td>${r.address}</td>
                <td>${r.phone}</td>
                <td>${r.owner?.username || "‚Äî"}</td>
                <td class="fw-bold text-center">${r.totalOrders ?? 0}</td>
                <td><span class="${r.active ? 'badge-open' : 'badge-closed'}">${r.active ? 'ƒêang ho·∫°t ƒë·ªông' : 'T·∫°m ng∆∞ng'}</span></td>
            </tr>
        `).join("");
    }

    function updateStats() {
        document.getElementById("totalRestaurants").innerText = restaurants.length;
        document.getElementById("openCount").innerText = restaurants.filter(r => r.active).length;
        document.getElementById("closedCount").innerText = restaurants.filter(r => !r.active).length;
    }

    async function createRestaurant() {
        const data = {
            name: document.getElementById("name").value.trim(),
            address: document.getElementById("address").value.trim(),
            phone: document.getElementById("phone").value.trim(),
            owner: document.getElementById("ownerSelect").value,   // <-- S·ª¨A T·∫†I ƒê√ÇY
            active: document.getElementById("status").value === "OPEN"
        };

        if (!data.name || !data.address || !data.phone || !data.owner) {
            alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/restaurants`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });

            if (!res.ok) {
                const errText = await res.text();
                throw new Error(errText);
            }

            alert("‚úÖ Th√™m nh√† h√†ng th√†nh c√¥ng!");
            await loadRestaurants();

        } catch (err) {
            console.error("‚ùå ERROR:", err);
            alert("L·ªói th√™m nh√† h√†ng:\n" + err.message);
        }
    }


    async function deleteRestaurant(id) {
        if (!confirm("X√≥a nh√† h√†ng?")) return;
        try {
            const res = await fetch(`${API_BASE}/restaurants/${id}`, { method: "DELETE" });
            if (!res.ok) throw new Error(await res.text());
            alert("üóë X√≥a th√†nh c√¥ng!");
            loadRestaurants();
        } catch {
            alert("‚ùå L·ªói khi x√≥a nh√† h√†ng!");
        }
    }

    document.getElementById("searchInput").addEventListener("input", e => {
        const kw = e.target.value.trim().toLowerCase();
        const filtered = !kw
            ? restaurants
            : restaurants.filter(r => [r.id, r.name, r.address, r.phone].some(v => v?.toLowerCase().includes(kw)));
        renderRestaurants(filtered);
    });

    function applyFilter() {
        const filter = document.getElementById("filterSelect").value;
        if (filter === "ALL") return renderRestaurants(restaurants);
        const max = Math.max(...restaurants.map(r => r.totalOrders));
        const min = Math.min(...restaurants.map(r => r.totalOrders));
        const filtered = filter === "MAX"
            ? restaurants.filter(r => r.totalOrders === max)
            : restaurants.filter(r => r.totalOrders === min);
        renderRestaurants(filtered);
    }

    (async () => {
        await loadUsers();
        await loadRestaurants();
    })();

</script>
</body>
</html>
