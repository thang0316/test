<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />

<div class="container p-3">
    <h3 class="text-primary mb-3">üöö Qu·∫£n l√Ω Giao h√†ng</h3>

    <div class="p-3 border bg-white rounded mb-3">
        <h5 class="text-success mb-3">‚ûï Th√™m giao h√†ng</h5>
        <div class="row g-2">
            <div class="col-md-4">
                <select id="orderSelectDelivery" class="form-select">
                    <option disabled selected>ƒêang t·∫£i ƒë∆°n h√†ng...</option>
                </select>
            </div>
            <div class="col-md-4">
                <select id="droneSelect" class="form-select" disabled>
                    <option disabled selected>Ch·ªçn ƒë∆°n h√†ng tr∆∞·ªõc</option>
                </select>
            </div>
            <div class="col-md-4 text-end">
                <button onclick="createDelivery()" class="btn btn-primary w-100">Th√™m</button>
            </div>
        </div>
    </div>

    <table class="table table-striped align-middle">
        <thead class="table-primary">
        <tr>
            <th>ID</th>
            <th>ƒê∆°n h√†ng</th>
            <th>Drone</th>
            <th>Tr·∫°ng th√°i</th>
            <th>B·∫Øt ƒë·∫ßu</th>
            <th>K·∫øt th√∫c</th>
            <th>H√†nh ƒë·ªông</th>
        </tr>
        </thead>
        <tbody id="deliveryTable">
        <tr><td colspan="7" class="text-center text-muted">ƒêang t·∫£i...</td></tr>
        </tbody>
    </table>
</div>

<script>
    var API = window.apiBase || "http://localhost:8080/api";

    function loadOrders() {
        fetch(API + "/orders")
            .then(r => r.json())
            .then(data => {
                const orders = data.filter(o => o.status === 'CONFIRMED');
                let html = '<option disabled selected>Ch·ªçn ƒë∆°n h√†ng</option>' + 
                    orders.map(o => `<option value="${o.id}" data-rid="${o.restaurant?.id}">#${o.id} - ${o.customer?.fullName}</option>`).join("");
                document.getElementById("orderSelectDelivery").innerHTML = html || '<option disabled>Kh√¥ng c√≥ ƒë∆°n h√†ng</option>';
                document.getElementById("orderSelectDelivery").addEventListener('change', filterDrones);
            })
            .catch(e => {
                console.error(e);
                document.getElementById("orderSelectDelivery").innerHTML = '<option disabled>L·ªói t·∫£i d·ªØ li·ªáu</option>';
            });
    }

    function filterDrones() {
        var opt = document.querySelector('#orderSelectDelivery option:checked');
        if(!opt || opt.disabled) {
            document.getElementById("droneSelect").innerHTML = '<option disabled selected>Ch·ªçn ƒë∆°n h√†ng tr∆∞·ªõc</option>';
            document.getElementById("droneSelect").disabled = true;
            return;
        }
        
        var rid = opt.getAttribute('data-rid');
        
        // Show loading
        document.getElementById("droneSelect").innerHTML = '<option disabled selected>ƒêang t·∫£i drone...</option>';
        document.getElementById("droneSelect").disabled = false;
        
        fetch(API + "/drones")
            .then(r => r.json())
            .then(data => {
                const drones = data.filter(d => d.restaurant?.id == rid && d.status === 'AVAILABLE');
                let html = '<option disabled selected>Ch·ªçn drone</option>' + 
                    drones.map(d => `<option value="${d.id}">${d.model} (${d.batteryLevel}%)</option>`).join("");
                document.getElementById("droneSelect").innerHTML = html || '<option disabled selected>Kh√¥ng c√≥ drone kh·∫£ d·ª•ng</option>';
            })
            .catch(e => {
                console.error(e);
                document.getElementById("droneSelect").innerHTML = '<option disabled>L·ªói t·∫£i drone</option>';
            });
    }

    function loadDeliveries() {
        fetch(API + "/deliveries")
            .then(r => r.json())
            .then(data => {
                console.log("üì¶", data.length, "deliveries");
                
                let rows = data.map(d => `<tr>
                    <td>${d.id}</td>
                    <td>#${d.order?.id || "-"}</td>
                    <td>${d.drone?.model || "-"}</td>
                    <td><select class="form-select form-select-sm" onchange="changeStatus('${d.id}', this.value)">
                        <option value="DELIVERING" ${d.status === 'DELIVERING' ? 'selected' : ''}>DELIVERING</option>
                        <option value="COMPLETED" ${d.status === 'COMPLETED' ? 'selected' : ''}>COMPLETED</option>
                        <option value="CANCELED" ${d.status === 'CANCELED' ? 'selected' : ''}>CANCELED</option>
                    </select></td>
                    <td>${d.startTime || "-"}</td>
                    <td>${d.endTime || "-"}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="deleteDelivery('${d.id}')">Delete</button></td>
                </tr>`).join("");
                document.getElementById("deliveryTable").innerHTML = rows || '<tr><td colspan="7" class="text-center">No deliveries</td></tr>';
            });
    }

    function createDelivery() {
        let oid = document.getElementById("orderSelectDelivery").value;
        let did = document.getElementById("droneSelect").value;
        if(!oid || !did) { alert("Select order & drone"); return; }
        
        fetch(API + "/deliveries", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({orderId: oid, droneId: did})
        }).then(r => r.ok && loadDeliveries());
    }

    function changeStatus(id, status) {
        fetch(API + "/deliveries/" + id + "/status?status=" + status, {method: "PUT"})
            .then(r => {
                if (!r.ok) {
                    alert("‚ùå L·ªói c·∫≠p nh·∫≠t: " + r.status);
                    loadDeliveries(); // reload ƒë·ªÉ restore tr·∫°ng th√°i c≈©
                    return;
                }
                console.log("‚úÖ Status updated:", status);
                loadDeliveries();
            })
            .catch(e => {
                alert("‚ùå Error: " + e.message);
                loadDeliveries();
            });
    }

    function deleteDelivery(id) {
        if(!confirm("Delete?")) return;
        fetch(API + "/deliveries/" + id, {method: "DELETE"})
            .then(() => loadDeliveries());
    }

    loadOrders();
    loadDeliveries();
</script>
