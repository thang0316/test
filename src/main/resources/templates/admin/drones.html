<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css" />
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js"></script>

<h3 class="text-primary mb-3">üöÅ Qu·∫£n l√Ω Drone</h3>

<div class="card p-3 mb-4">
    <h5 class="text-success mb-3">‚ûï Th√™m Drone</h5>

    <div class="row g-2">
        <div class="col-md-3">
            <input id="model" class="form-control" placeholder="Model">
        </div>

        <div class="col-md-3">
            <input id="battery" type="number" class="form-control" placeholder="Pin (%)">
        </div>

        <div class="col-md-3">
            <select id="restaurantSelect" class="form-select">
                <option disabled selected>ƒêang t·∫£i nh√† h√†ng...</option>
            </select>
        </div>

        <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="addDrone()">Th√™m</button>
        </div>
    </div>
</div>

<div id="droneMap" style="height: 400px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>

<table class="table table-bordered table-striped">
    <thead class="table-primary">
    <tr>
        <th>ID</th>
        <th>Model</th>
        <th>Pin</th>
        <th>Tr·∫°ng th√°i</th>
        <th>Vƒ© ƒë·ªô</th>
        <th>Kinh ƒë·ªô</th>
        <th>Nh√† h√†ng</th>
        <th>X√≥a</th>
    </tr>
    </thead>
    <tbody id="droneTable">
    <tr><td colspan="8" class="text-center">ƒêang t·∫£i...</td></tr>
    </tbody>
</table>

<script>
    const API = window.apiBase || "http://localhost:8080/api";
    console.log("API Base:", API);
    
    let restaurantsCache = null; // Cache nh√† h√†ng
    let map = null;
    let mapInit = false;
    let autoRefreshInterval = null;
    let isAutoRefreshEnabled = true;
    let refreshIntervalMs = 2000; // 2 gi√¢y

    // ========== MAP FUNCTIONS ==========
    function initMap() {
        if(mapInit || !window.L) return;
        mapInit = true;
        
        try {
            map = L.map('droneMap', {center: [21.0285, 105.8542], zoom: 13});
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 19}).addTo(map);
            console.log("‚úÖ Map ready");
        } catch(e) {
            console.error("Map error:", e);
            createPlaceholder();
        }
    }
    
    function createPlaceholder() {
        document.getElementById('droneMap').innerHTML = 
            '<div style="width:100%;height:100%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;text-align:center;padding:20px;box-sizing:border-box"><div><div style="font-size:24px">üó∫Ô∏è</div><div>Map unavailable</div></div></div>';
    }

    function updateMarkers(data) {
        if(!map) return;
        try {
            // Clear old markers
            if(map._layers) {
                Object.keys(map._layers).forEach(key => {
                    let layer = map._layers[key];
                    if(layer && layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
            }
            
            data.forEach(d => {
                if(d.currentLatitude && d.currentLongitude) {
                    // M√†u theo tr·∫°ng th√°i
                    let color = '#6c757d'; // OFFLINE - gray
                    let statusEmoji = '‚ö´';
                    
                    if(d.status === 'AVAILABLE') {
                        color = '#28a745'; // green
                        statusEmoji = 'üü¢';
                    } else if(d.status === 'DELIVERING') {
                        color = '#0d6efd'; // blue
                        statusEmoji = 'üîµ';
                    } else if(d.status === 'CHARGING') {
                        color = '#ffc107'; // yellow
                        statusEmoji = 'üü°';
                    }
                    
                    // Create animated icon with drone emoji
                    var customIcon = L.divIcon({
                        html: `<div style="background:${color}; color:white; padding:6px 10px; border-radius:50%; text-align:center; font-weight:bold; width:32px; height:32px; display:flex; align-items:center; justify-content:center; box-shadow: 0 2px 6px rgba(0,0,0,0.3); animation: pulse 2s infinite;">üöÅ</div>`,
                        iconSize: [32, 32],
                        className: 'drone-marker'
                    });
                    
                    let popupContent = `
                        <div style="min-width: 180px;">
                            <h6 style="margin:0 0 8px 0; color: ${color};">
                                ${statusEmoji} ${d.model}
                            </h6>
                            <small>
                                <strong>ID:</strong> ${d.id}<br>
                                <strong>Tr·∫°ng th√°i:</strong> <span style="color: ${color};">${d.status}</span><br>
                                <strong>Pin:</strong> ${d.batteryLevel}%<br>
                                <strong>V·ªã tr√≠:</strong><br>
                                ‚Ä¢ Vƒ© ƒë·ªô: ${d.currentLatitude.toFixed(6)}<br>
                                ‚Ä¢ Kinh ƒë·ªô: ${d.currentLongitude.toFixed(6)}<br>
                                <strong>Nh√† h√†ng:</strong> ${d.restaurant?.name || '‚Äî'}
                            </small>
                        </div>
                    `;
                    
                    L.marker([d.currentLatitude, d.currentLongitude], {
                        icon: customIcon
                    }).bindPopup(popupContent).addTo(map);
                }
            });
            
            console.log("‚úÖ Markers updated:", data.length, "drones at", new Date().toLocaleTimeString());
        } catch(e) { 
            console.error("Marker error:", e); 
        }
    }

    // ========== LOAD RESTAURANTS ==========
    function loadRestaurants() {
        const sel = document.getElementById("restaurantSelect");

        console.log("üìç B·∫Øt ƒë·∫ßu load restaurants...");

        fetch(API + "/restaurants")
            .then(res => {
                console.log("Response status:", res.status);
                if(!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            })
            .then(data => {
                console.log("‚úì Restaurants loaded:", data);
                restaurantsCache = data;

                if(!data || data.length === 0) {
                    console.warn("‚ö†Ô∏è Kh√¥ng c√≥ nh√† h√†ng");
                    sel.innerHTML = `<option value="">-- Ch·ªçn nh√† h√†ng --</option>`;
                    return;
                }

                sel.innerHTML = `<option value="">-- Ch·ªçn nh√† h√†ng --</option>` + 
                    data.map(r => `<option value="${r.id}">${r.name}</option>`).join("");
                
                console.log("‚úì Select updated - c√≥", sel.options.length, "nh√† h√†ng");
            })
            .catch(err => {
                console.error("‚úó L·ªói fetch restaurants:", err);
                sel.innerHTML = `<option value="">-- L·ªói t·∫£i nh√† h√†ng --</option>`;
            });
    }

    // ========== LOAD DRONES ==========
    async function loadDrones() {
        const tbody = document.getElementById("droneTable");

        try {
            const res = await fetch(API + "/drones");
            const data = await res.json();

            if (!data.length) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center">Ch∆∞a c√≥ drone n√†o</td></tr>`;
                if(map) updateMarkers([]); // Clear markers
                return;
            }

            tbody.innerHTML = data.map(d => {
                let statusColor = '#6c757d';
                if(d.status === 'AVAILABLE') statusColor = '#28a745';
                else if(d.status === 'DELIVERING') statusColor = '#0d6efd';
                else if(d.status === 'CHARGING') statusColor = '#ffc107';
                
                return `
                <tr>
                    <td>${d.id}</td>
                    <td>${d.model}</td>
                    <td>${d.batteryLevel}%</td>
                    <td><span style="color: ${statusColor}; font-weight: bold;">‚óè</span> ${d.status}</td>
                    <td>${d.currentLatitude?.toFixed(6) || "‚Äî"}</td>
                    <td>${d.currentLongitude?.toFixed(6) || "‚Äî"}</td>
                    <td>${d.restaurant?.name || "‚Äî"}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteDrone('${d.id}')">X√≥a</button>
                    </td>
                </tr>
            `}).join("");

            // Update markers on map
            if(map) updateMarkers(data);

        } catch (err) {
            console.error("Load drones error:", err);
            tbody.innerHTML = `<tr><td colspan="8" class="text-danger text-center">L·ªói t·∫£i drone</td></tr>`;
        }
    }
    
    // ========== AUTO REFRESH ==========
    function startAutoRefresh() {
        if(autoRefreshInterval) clearInterval(autoRefreshInterval);
        
        autoRefreshInterval = setInterval(() => {
            if(isAutoRefreshEnabled) {
                loadDrones(); // Ch·ªâ refresh b·∫£n ƒë·ªì, kh√¥ng refresh to√†n b·ªô b·∫£ng
            }
        }, refreshIntervalMs);
        
        console.log("üîÑ Auto-refresh started:", refreshIntervalMs + "ms");
    }
    
    function stopAutoRefresh() {
        if(autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
        console.log("‚è∏Ô∏è Auto-refresh stopped");
    }
    
    function toggleAutoRefresh() {
        isAutoRefreshEnabled = !isAutoRefreshEnabled;
        const btn = document.getElementById("toggleAutoRefresh");
        
        if(isAutoRefreshEnabled) {
            btn.innerHTML = '<i class="bi bi-pause-fill"></i> T·∫°m d·ª´ng';
            btn.className = 'btn btn-sm btn-primary';
            console.log("‚ñ∂Ô∏è Auto-refresh resumed");
        } else {
            btn.innerHTML = '<i class="bi bi-play-fill"></i> Ti·∫øp t·ª•c';
            btn.className = 'btn btn-sm btn-secondary';
            console.log("‚è∏Ô∏è Auto-refresh paused");
        }
    }

    // ========== CREATE ==========
    async function addDrone() {
        const data = {
            model: document.getElementById("model").value,
            batteryLevel: Number(document.getElementById("battery").value),
            restaurantId: document.getElementById("restaurantSelect").value
        };

        if (!data.model || !data.restaurantId) {
            alert("Vui l√≤ng nh·∫≠p ƒë·ªß!");
            return;
        }

        const res = await fetch(API + "/drones", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (!res.ok) {
            alert("‚ùå L·ªói API!");
            return;
        }

        alert("üéâ Th√™m drone th√†nh c√¥ng!");
        restaurantsCache = null;  // X√≥a cache ƒë·ªÉ l·∫ßn sau fetch l·∫°i
        loadDrones();
    }

    // ========== DELETE ==========
    async function deleteDrone(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc?")) return;

        await fetch(API + "/drones/" + id, { method: "DELETE" });
        loadDrones();
    }

    // INIT
    function init() {
        console.log("üöÄ Init page...");
        // Pre-load restaurants ngay
        loadRestaurants();
        // Load drones
        loadDrones();
        
        // Lazy init map
        setTimeout(() => {
            if(window.L) {
                initMap();
                // Start auto-refresh after map is ready
                setTimeout(() => startAutoRefresh(), 1000);
            }
        }, 300);
    }
    
    // Cleanup khi r·ªùi trang
    window.addEventListener('beforeunload', () => {
        stopAutoRefresh();
    });
    
    init();
</script>

<style>
    @keyframes pulse {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.1);
            opacity: 0.8;
        }
    }
    
    .drone-marker {
        transition: all 0.3s ease;
    }
</style>
