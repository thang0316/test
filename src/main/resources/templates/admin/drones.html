<h3 class="text-primary mb-3">üöÅ Qu·∫£n l√Ω Drone</h3>

<div class="card p-3 mb-4">
    <h5 class="text-success mb-3">‚ûï Th√™m Drone</h5>

    <div class="row g-2">
        <div class="col-md-3">
            <input id="model" class="form-control" placeholder="Model">
        </div>

        <div class="col-md-3">
            <input id="battery" type="number" class="form-control" placeholder="Pin (%)">
        </div>

        <div class="col-md-3">
            <select id="restaurantSelect" class="form-select">
                <option disabled selected>ƒêang t·∫£i nh√† h√†ng...</option>
            </select>
        </div>

        <div class="col-md-2">
            <button class="btn btn-primary w-100" onclick="addDrone()">Th√™m</button>
        </div>
    </div>
</div>

<div class="card p-3 mb-4">
    <h5 class="text-info mb-3">üìç C·∫≠p nh·∫≠t v·ªã tr√≠ Drone</h5>
    <div class="row g-2">
        <div class="col-md-3">
            <select id="droneSelectLocation" class="form-select">
                <option disabled selected>Ch·ªçn drone...</option>
            </select>
        </div>
        <div class="col-md-2">
            <input id="simLatitude" type="number" class="form-control" placeholder="Vƒ© ƒë·ªô" step="0.000001" value="21.0285">
        </div>
        <div class="col-md-2">
            <input id="simLongitude" type="number" class="form-control" placeholder="Kinh ƒë·ªô" step="0.000001" value="105.8542">
        </div>
        <div class="col-md-2">
            <button onclick="updateDroneLocation()" class="btn btn-info w-100">C·∫≠p nh·∫≠t</button>
        </div>
    </div>
</div>

<table class="table table-bordered table-striped">
    <thead class="table-primary">
    <tr>
        <th>ID</th>
        <th>Model</th>
        <th>Pin</th>
        <th>Tr·∫°ng th√°i</th>
        <th>Vƒ© ƒë·ªô</th>
        <th>Kinh ƒë·ªô</th>
        <th>Nh√† h√†ng</th>
        <th>X√≥a</th>
    </tr>
    </thead>
    <tbody id="droneTable">
    <tr><td colspan="8" class="text-center">ƒêang t·∫£i...</td></tr>
    </tbody>
</table>

<script>
    const API = window.apiBase || "http://localhost:8080/api";
    console.log("API Base:", API);
    
    let restaurantsCache = null; // Cache nh√† h√†ng

    // ========== LOAD RESTAURANTS ==========
    function loadRestaurants() {
        const sel = document.getElementById("restaurantSelect");

        console.log("üìç B·∫Øt ƒë·∫ßu load restaurants...");

        fetch(API + "/restaurants")
            .then(res => {
                console.log("Response status:", res.status);
                if(!res.ok) throw new Error(`HTTP ${res.status}`);
                return res.json();
            })
            .then(data => {
                console.log("‚úì Restaurants loaded:", data);
                restaurantsCache = data;

                if(!data || data.length === 0) {
                    console.warn("‚ö†Ô∏è Kh√¥ng c√≥ nh√† h√†ng");
                    sel.innerHTML = `<option value="">-- Ch·ªçn nh√† h√†ng --</option>`;
                    return;
                }

                sel.innerHTML = `<option value="">-- Ch·ªçn nh√† h√†ng --</option>` + 
                    data.map(r => `<option value="${r.id}">${r.name}</option>`).join("");
                
                console.log("‚úì Select updated - c√≥", sel.options.length, "nh√† h√†ng");
            })
            .catch(err => {
                console.error("‚úó L·ªói fetch restaurants:", err);
                sel.innerHTML = `<option value="">-- L·ªói t·∫£i nh√† h√†ng --</option>`;
            });
    }

    // ========== LOAD DRONES ==========
    async function loadDrones() {
        const tbody = document.getElementById("droneTable");

        try {
            const res = await fetch(API + "/drones");
            const data = await res.json();

            if (!data.length) {
                tbody.innerHTML = `<tr><td colspan="8" class="text-center">Ch∆∞a c√≥ drone n√†o</td></tr>`;
                return;
            }

            // Populate dropdown
            const droneSelect = document.getElementById("droneSelectLocation");
            droneSelect.innerHTML = '<option disabled selected>Ch·ªçn drone...</option>' +
                data.map(d => `<option value="${d.id}">${d.model} (${d.id})</option>`).join("");

            tbody.innerHTML = data.map(d => `
                <tr>
                    <td>${d.id}</td>
                    <td>${d.model}</td>
                    <td>${d.batteryLevel}%</td>
                    <td>${d.status}</td>
                    <td>${d.currentLatitude?.toFixed(6) || "‚Äî"}</td>
                    <td>${d.currentLongitude?.toFixed(6) || "‚Äî"}</td>
                    <td>${d.restaurant?.name || "‚Äî"}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteDrone('${d.id}')">X√≥a</button>
                    </td>
                </tr>
            `).join("");

        } catch (err) {
            tbody.innerHTML = `<tr><td colspan="8" class="text-danger text-center">L·ªói t·∫£i drone</td></tr>`;
        }
    }

    // ========== CREATE ==========
    async function addDrone() {
        const data = {
            model: document.getElementById("model").value,
            batteryLevel: Number(document.getElementById("battery").value),
            restaurantId: document.getElementById("restaurantSelect").value
        };

        if (!data.model || !data.restaurantId) {
            alert("Vui l√≤ng nh·∫≠p ƒë·ªß!");
            return;
        }

        const res = await fetch(API + "/drones", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
        });

        if (!res.ok) {
            alert("‚ùå L·ªói API!");
            return;
        }

        alert("üéâ Th√™m drone th√†nh c√¥ng!");
        restaurantsCache = null;  // X√≥a cache ƒë·ªÉ l·∫ßn sau fetch l·∫°i
        loadDrones();
    }

    // ========== DELETE ==========
    async function deleteDrone(id) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc?")) return;

        await fetch(API + "/drones/" + id, { method: "DELETE" });
        loadDrones();
    }

    // ========== UPDATE LOCATION ==========
    async function updateDroneLocation() {
        const droneId = document.getElementById("droneSelectLocation").value;
        const lat = parseFloat(document.getElementById("simLatitude").value);
        const lng = parseFloat(document.getElementById("simLongitude").value);
        
        if(!droneId || isNaN(lat) || isNaN(lng)) { 
            alert("‚ùå Ch·ªçn drone v√† nh·∫≠p t·ªça ƒë·ªô h·ª£p l·ªá!"); 
            return; 
        }
        
        try {
            const res = await fetch(API + "/drones/" + droneId + "/location?latitude=" + lat + "&longitude=" + lng, {
                method: "PUT",
                headers: {"Content-Type": "application/json"}
            });
            
            if (!res.ok) {
                alert("‚ùå L·ªói c·∫≠p nh·∫≠t v·ªã tr√≠: " + res.status);
                return;
            }
            
            alert("‚úÖ V·ªã tr√≠ drone c·∫≠p nh·∫≠t th√†nh c√¥ng!");
            console.log("‚úÖ Location updated to:", lat, lng);
            loadDrones();
        } catch (e) {
            alert("‚ùå Error: " + e.message);
            console.error("Location update error:", e);
        }
    }

    // INIT
    function init() {
        console.log("üöÄ Init page...");
        // Pre-load restaurants ngay
        loadRestaurants();
        // Load drones
        loadDrones();
    }
    
    init();
</script>
