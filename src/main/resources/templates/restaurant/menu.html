<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Menu Nh√† h√†ng</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background: #eef2f5; font-family: "Segoe UI", sans-serif; }

        .sidebar {
            position: fixed; top: 0; left: 0;
            width: 230px; height: 100vh;
            background: linear-gradient(180deg, #198754, #146c43);
            padding-top: 25px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.15);
        }

        .sidebar a {
            color: white; padding: 12px 20px;
            display: block; text-decoration: none;
            border-left: 4px solid transparent;
            transition: 0.25s;
            font-weight: 500;
        }

        .sidebar a:hover {
            background: rgba(255,255,255,0.12);
            border-left: 4px solid white;
        }

        .content-area { margin-left: 250px; padding: 25px; }
        h3 { font-weight: 700; color: #333; }

        table.table { background: white; border-radius: 10px; overflow: hidden; }
        thead { background: #198754; color: white; }
        tbody tr:hover { background: #f3f6ff; }

        img.menu-thumb {
            width: 60px; height: 60px;
            object-fit: cover; border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }

        .btn-primary { background: #198754; border: none; }
        .btn-primary:hover { background: #12693d; }

        .modal-content { border-radius: 12px; }
    </style>
</head>

<body>

<div class="sidebar">
    <a href="/restaurant/dashboard">üè† Dashboard</a>
    <a href="/restaurant/menu">üçï Menu</a>
    <a href="/restaurant/orders">üì¶ ƒê∆°n h√†ng</a>
    <a href="/restaurant/drones">üõ© Drone</a>
    <a href="/restaurant/profile">üë§ H·ªì s∆°</a>
</div>

<div class="content-area">
    <h3>üçï Menu nh√† h√†ng</h3>

    <button class="btn btn-primary my-3" onclick="openModal()">+ Th√™m m√≥n</button>

    <table class="table table-bordered">
        <thead>
        <tr>
            <th>ID</th>
            <th>·∫¢nh</th>
            <th>T√™n m√≥n</th>
            <th>Gi√°</th>
            <th>M√¥ t·∫£</th>
            <th>Tr·∫°ng th√°i</th>
            <th></th>
        </tr>
        </thead>
        <tbody id="menuTable"></tbody>
    </table>
</div>

<!-- Modal th√™m m√≥n -->
<div class="modal fade" id="menuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content p-3">
            <h5>Th√™m m√≥n m·ªõi</h5>

            <input class="form-control mb-2" id="name" placeholder="T√™n m√≥n">
            <input class="form-control mb-2" id="price" placeholder="Gi√°">

            <label class="fw-bold mt-2">·∫¢nh m√≥n ƒÉn:</label>
            <input type="file" id="imageFile" class="form-control mb-2" accept="image/*">

            <textarea id="desc" class="form-control mb-2" placeholder="M√¥ t·∫£"></textarea>

            <button class="btn btn-success w-100" onclick="addMenu()">Th√™m</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

    let restaurantId = null;

    /* ===================================================
           1) FIX LOAD RESTAURANT 100% ƒê√öNG KEY
    =================================================== */
    async function loadRestaurant() {

        // ‚≠ê l·∫•y user ƒë√∫ng key (g·ªôp c·∫£ 2 lo·∫°i)
        const user =
            JSON.parse(localStorage.getItem("loggedInUser")) ||
            JSON.parse(localStorage.getItem("user"));

        console.log("User trong localStorage:", user);

        if (!user || !user.id) {
            alert("B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
            window.location.href = "/login";
            return;
        }

        const ownerId = String(user.id).trim();
        console.log("User ID sau khi trim:", ownerId);

        const res = await fetch("/api/restaurants");
        const restaurants = await res.json();

        console.log("Danh s√°ch restaurants:", restaurants);

        // ‚≠ê So s√°nh an to√†n
        const myRestaurant = restaurants.find(r =>
            r.owner?.id && String(r.owner.id).trim() === ownerId
        );

        console.log("Nh√† h√†ng t√¨m ƒë∆∞·ª£c:", myRestaurant);

        if (!myRestaurant) {
            alert("‚ö† T√†i kho·∫£n kh√¥ng c√≥ nh√† h√†ng! Li√™n h·ªá Admin ƒë·ªÉ t·∫°o.");
            return;
        }

        // ‚≠ê Save ID
        restaurantId = myRestaurant.id;
        console.log("Restaurant ID:", restaurantId);

        loadMenu();
    }

    /* ===================================================
           2) Load danh s√°ch m√≥n ƒë√∫ng nh√† h√†ng
    =================================================== */
    function loadMenu() {
        fetch("/api/menu-items")
            .then(res => res.json())
            .then(list => {
                const table = document.getElementById("menuTable");
                table.innerHTML = "";

                const myMenuItems = list.filter(m => m.restaurant?.id === restaurantId);
                
                if(myMenuItems.length === 0) {
                    table.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Ch∆∞a c√≥ m√≥n n√†o</td></tr>`;
                    return;
                }

                myMenuItems.forEach(m => {

                        const imgTag = m.imageUrl
                            ? `<img src="/images/${m.imageUrl}" class="menu-thumb" onerror="this.style.display='none';">`
                            : `<span class='text-muted'>Kh√¥ng c√≥ ·∫£nh</span>`;

                        table.innerHTML += `
                        <tr>
                            <td>${m.id}</td>
                            <td>${imgTag}</td>
                            <td>${m.name}</td>
                            <td>${m.price.toLocaleString()} ‚Ç´</td>
                            <td>${m.description || ""}</td>
                            <td>${m.available ? "‚úî C√≤n" : "‚ùå H·∫øt"}</td>
                            <td>
                                <button class='btn btn-danger btn-sm' onclick="deleteMenu(${m.id})">X√≥a</button>
                            </td>
                        </tr>`;
                    });
            })
            .catch(err => {
                console.error("L·ªói t·∫£i menu:", err);
                const table = document.getElementById("menuTable");
                table.innerHTML = `<tr><td colspan="7" class="text-center text-danger">L·ªói t·∫£i menu</td></tr>`;
            });
    }

    /* ===================================================
           3) Modal
    =================================================== */
    function openModal() {
        new bootstrap.Modal(document.getElementById("menuModal")).show();
    }

    /* ===================================================
           4) Th√™m m√≥n
    =================================================== */
    async function addMenu() {

        const fileInput = document.getElementById("imageFile");
        let imageUrl = null;

        if (fileInput.files.length > 0) {
            imageUrl = fileInput.files[0].name;
        }

        const item = {
            name: document.getElementById("name").value,
            price: Number(document.getElementById("price").value),
            description: document.getElementById("desc").value,
            imageUrl: imageUrl,
            restaurantId: restaurantId,
            available: true
        };

        const res = await fetch("/api/menu-items", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(item)
        });

        if (!res.ok) {
            alert("‚ùå Kh√¥ng th·ªÉ t·∫°o m√≥n!");
            return;
        }

        alert("‚úî Th√™m m√≥n th√†nh c√¥ng!");
        loadMenu();
    }

    /* ===================================================
           5) X√≥a m√≥n
    =================================================== */
    function deleteMenu(id) {
        fetch(`/api/menu-items/${id}`, { method: "DELETE" })
            .then(() => {
                alert("ƒê√£ x√≥a m√≥n");
                loadMenu();
            });
    }

    // ‚≠ê KH·ªûI CH·∫†Y
    loadRestaurant();

</script>

</body>
</html>
