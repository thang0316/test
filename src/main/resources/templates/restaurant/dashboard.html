<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Dashboard | Restaurant</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { background: #eef2f5; font-family: "Segoe UI"; }

        .sidebar {
            position: fixed;
            top: 0; left: 0;
            width: 220px; height: 100vh;
            background: #198754;
            padding-top: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.15);
        }
        .sidebar a {
            color: white; text-decoration:none;
            padding: 14px 20px; display:block;
            font-weight: 500;
        }
        .sidebar a:hover { background: rgba(255,255,255,0.18); }

        .content { margin-left: 240px; padding: 25px; }
        .card-box { padding:25px; border-radius:12px; background:white; box-shadow:0 3px 10px rgba(0,0,0,0.08); }
    </style>
</head>
<body>

<div class="sidebar">
    <a href="/restaurant/dashboard">ğŸ  Dashboard</a>
    <a href="/restaurant/menu">ğŸ• Menu</a>
    <a href="/restaurant/orders">ğŸ“¦ ÄÆ¡n hÃ ng</a>
    <a href="/restaurant/drones">ğŸ›© Drone</a>
    <a href="/restaurant/profile">ğŸ‘¤ Há»“ sÆ¡</a>
</div>

<div class="content">
    <h2>ğŸ  Dashboard NhÃ  hÃ ng</h2>

    <div class="row mt-4">
        <div class="col-4"><div class="card-box">
            <h5>ğŸ“¦ Tá»•ng Ä‘Æ¡n</h5>
            <h2 id="orderCount">0</h2>
        </div></div>

        <div class="col-4"><div class="card-box">
            <h5>ğŸ›© Drone hoáº¡t Ä‘á»™ng</h5>
            <h2 id="droneActive">0</h2>
        </div></div>

        <div class="col-4"><div class="card-box">
            <h5>ğŸ’° Doanh thu</h5>
            <h2 id="revenue">0 â‚«</h2>
        </div></div>
    </div>

    <!-- ====================== BIá»‚U Äá»’ ====================== -->
    <div class="row mt-4">
        <div class="col-7">
            <div class="card-box">
                <h5>ğŸ“Š Doanh thu theo ngÃ y</h5>
                <canvas id="chartRevenue"></canvas>
            </div>
        </div>

        <div class="col-5">
            <div class="card-box">
                <h5>ğŸ“ˆ Tá»· lá»‡ Ä‘Æ¡n hÃ ng</h5>
                <canvas id="chartOrders"></canvas>
            </div>
        </div>
    </div>

</div>

<script>
    const restaurantId = localStorage.getItem("restaurantId");

    /* ======================================
           BIáº¾N DÃ™NG CHO BIá»‚U Äá»’
    ====================================== */
    let completedCount = 0;
    let processingCount = 0;
    let cancelledCount = 0;

    let revenuePerDay = {};

    /* ================================
           1) Tá»•ng Ä‘Æ¡n hÃ ng + DOANH THU
    ================================= */
    async function loadOrderStats() {
        const orderRes = await fetch(`/api/orders`);
        const list = await orderRes.json();
        const myOrders = list.filter(o => o.restaurant.id === restaurantId);

        let paidOrders = [];
        let totalRevenue = 0;

        for(let order of myOrders) {

            // ----- Ä‘áº¿m tráº¡ng thÃ¡i Ä‘á»ƒ váº½ biá»ƒu Ä‘á»“ -----
            if(order.status === "COMPLETED") completedCount++;
            if(order.status === "PROCESSING") processingCount++;
            if(order.status === "CANCELLED") cancelledCount++;

            // ----- load payment -----
            const paymentRes = await fetch(`/api/payments/order/${order.id}`);
            const payments = await paymentRes.json();
            const completedPayment = payments.find(p => p.status === 'COMPLETED');

            // ----- Ä‘Æ¡n Ä‘Ã£ thanh toÃ¡n -----
            if(completedPayment && order.status === 'COMPLETED') {
                paidOrders.push(order);
                totalRevenue += order.totalAmount;

                // gom doanh thu theo ngÃ y
                let day = order.createdAt?.substring(0,10);
                if(day){
                    if(!revenuePerDay[day]) revenuePerDay[day] = 0;
                    revenuePerDay[day] += order.totalAmount;
                }
            }
        }

        orderCount.innerText = paidOrders.length;
        revenue.innerText = totalRevenue.toLocaleString("vi-VN") + " â‚«";

        drawCharts();
    }
    loadOrderStats();

    /* ================================
           2) Drone hoáº¡t Ä‘á»™ng
    ================================= */
    fetch(`/api/drones/restaurant/${restaurantId}`)
        .then(r => r.json())
        .then(list => {
            droneActive.innerText = list.filter(x => x.status === "AVAILABLE").length;
        });

    /* ================================
           3) Váº¼ BIá»‚U Äá»’
    ================================= */
    function drawCharts() {

        // ===== Biá»ƒu Ä‘á»“ doanh thu theo ngÃ y =====
        new Chart(document.getElementById("chartRevenue"), {
            type: "bar",
            data: {
                labels: Object.keys(revenuePerDay),
                datasets: [{
                    label: "Doanh thu (â‚«)",
                    data: Object.values(revenuePerDay),
                    backgroundColor: "#0d6efd"
                }]
            }
        });

        // ===== Biá»ƒu Ä‘á»“ tráº¡ng thÃ¡i Ä‘Æ¡n hÃ ng =====
        new Chart(document.getElementById("chartOrders"), {
            type: "pie",
            data: {
                labels: ["HoÃ n thÃ nh", "Äang xá»­ lÃ½", "ÄÃ£ há»§y"],
                datasets: [{
                    data: [completedCount, processingCount, cancelledCount],
                    backgroundColor: ["#28a745", "#ffc107", "#dc3545"]
                }]
            }
        });
    }

</script>

</body>
</html>
