<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì¶ Qu·∫£n l√Ω ƒê∆°n h√†ng | FoodFast Admin</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

    <style>
        body { background-color:#f9fafc; color:#212529; font-family:"Segoe UI",sans-serif; padding:2rem; }
        h2 { font-weight:700; color:#0d6efd; display:flex; align-items:center; gap:10px; }
        .subtitle { color:#6c757d; margin-top:-6px; margin-bottom:1.5rem; }
        .card { background-color:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 3px 10px rgba(0,0,0,0.05); }
        .form-control, .form-select { background-color:#f8f9fa; color:#212529; border:1px solid #ced4da; border-radius:8px; }
        .btn-gradient { background:linear-gradient(90deg,#0d6efd,#00b4d8); border:none; color:white; font-weight:600; transition:all .3s; }
        .btn-gradient:hover { opacity:.9; transform:translateY(-1px); }
        .table thead { background-color:#0d6efd; color:white; }
        .table tbody tr:hover { background-color:#eef4ff; cursor:pointer; }
    </style>
</head>

<body>
<div class="container">
    <h2><i class="bi bi-basket2"></i> Qu·∫£n l√Ω ƒê∆°n h√†ng</h2>
    <p class="subtitle">T·∫°o, qu·∫£n l√Ω v√† theo d√µi ƒë∆°n h√†ng trong h·ªá th·ªëng</p>

    <!-- FORM T·∫†O ƒê∆†N -->
    <div class="card p-4 mb-4">
        <h5 class="text-primary mb-3"><i class="bi bi-plus-circle"></i> T·∫°o ƒë∆°n h√†ng m·ªõi</h5>

        <div class="row g-2">
            <div class="col-md-3"><select id="userSelect" class="form-select"></select></div>
            <div class="col-md-3"><select id="restaurantSelect" class="form-select"></select></div>
            <div class="col-md-3"><input id="customerName" class="form-control" placeholder="T√™n kh√°ch h√†ng"></div>
            <div class="col-md-3"><input id="customerPhone" class="form-control" placeholder="S·ªë ƒëi·ªán tho·∫°i"></div>
        </div>

        <div class="row g-2 mt-2">
            <div class="col-md-3"><input id="customerAddress" class="form-control" placeholder="ƒê·ªãa ch·ªâ giao h√†ng"></div>
            <div class="col-md-4"><select id="menuSelect" class="form-select"></select></div>
            <div class="col-md-2"><input id="quantity" type="number" value="1" min="1" class="form-control"></div>
            <div class="col-md-3"><button class="btn btn-gradient w-100" onclick="addMenuItem()">Th√™m m√≥n</button></div>
        </div>

        <div class="mt-3">
            <h6 class="text-primary"><i class="bi bi-list-check"></i> M√≥n ƒë√£ ch·ªçn</h6>
            <ul id="selectedItems" class="list-group"></ul>
        </div>

        <button class="btn btn-success w-100 mt-3" onclick="createOrder()">T·∫°o ƒë∆°n h√†ng</button>
    </div>

    <!-- DANH S√ÅCH ƒê∆†N -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-hover mb-0 align-middle">
                <thead>
                <tr>
                    <th>ID</th><th>Kh√°ch h√†ng</th><th>Nh√† h√†ng</th>
                    <th>T·ªïng ti·ªÅn</th><th>Tr·∫°ng th√°i</th><th>H√†nh ƒë·ªông</th>
                </tr>
                </thead>
                <tbody id="orderTable">
                <tr><td colspan="6" class="text-center text-muted fst-italic">ƒêang t·∫£i...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const API_BASE = window.apiBase || (window.location.origin + "/api");
    let menuItems = [];
    let selectedItems = [];

    /* ===========================
       LOAD DROPDOWN
    =========================== */

    async function loadUsers() {
        const res = await fetch(API_BASE + "/users");
        userSelect.innerHTML = (await res.json()).map(u =>
            `<option value="${u.id}">${u.username}</option>`
        ).join("");
    }

    async function loadRestaurants() {
        const res = await fetch(API_BASE + "/restaurants");
        restaurantSelect.innerHTML = (await res.json()).map(r =>
            `<option value="${r.id}">${r.name}</option>`
        ).join("");
    }

    async function loadMenuItems() {
        const res = await fetch(API_BASE + "/menu-items");
        menuItems = await res.json();
        menuSelect.innerHTML = menuItems.map(m =>
            `<option value="${m.id}">${m.name} - ${m.price}‚Ç´</option>`
        ).join("");
    }

    /* ===========================
       CH·ªåN M√ìN
    =========================== */

    function addMenuItem() {
        const id = menuSelect.value;
        const qty = parseInt(quantity.value);

        if (!id || qty <= 0) return alert("Ch·ªçn m√≥n v√† s·ªë l∆∞·ª£ng h·ª£p l·ªá!");

        const item = menuItems.find(m => m.id == id);
        selectedItems.push({ menuItemId:id, name:item.name, quantity:qty, price:item.price });

        renderSelectedItems();
    }

    function renderSelectedItems() {
        selectedItemsEl.innerHTML = selectedItems.map((i, idx) => `
            <li class="list-group-item d-flex justify-content-between">
                <div><b>${i.name}</b> √ó ${i.quantity}</div>
                <button class="btn btn-sm btn-danger" onclick="removeItem(${idx})">
                    <i class="bi bi-x"></i>
                </button>
            </li>
        `).join("");
    }

    function removeItem(index) {
        selectedItems.splice(index,1);
        renderSelectedItems();
    }

    /* ===========================
       T·∫†O ƒê∆†N
    =========================== */

    async function createOrder() {
        if (selectedItems.length === 0) return alert("C·∫ßn √≠t nh·∫•t 1 m√≥n!");

        const data = {
            userId: userSelect.value,
            restaurantId: restaurantSelect.value,
            customerName: customerName.value,
            customerPhone: customerPhone.value,
            customerAddress: customerAddress.value,
            items: selectedItems.map(i => ({ menuItemId:i.menuItemId, quantity:i.quantity }))
        };

        await fetch(API_BASE + "/orders", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify(data)
        });

        alert("T·∫°o ƒë∆°n th√†nh c√¥ng!");
        selectedItems = [];
        renderSelectedItems();
        loadOrders();
    }

    /* ===========================
       LOAD ƒê∆†N ‚Äî FIX FULL
    =========================== */

    async function loadOrders() {
        const res = await fetch(API_BASE + "/orders");
        const orders = await res.json();

        orderTable.innerHTML = orders.map(o => {
            return `
                <tr>
                    <td>${o.id}</td>
                    <td>${o.customerName}</td>
                    <td>${o.restaurant?.name}</td>
                    <td>${o.totalAmount?.toLocaleString()} ‚Ç´</td>

                    <td>
                        <span class="">${o.status}</span>
                    </td>

                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrderDetail(${o.id})">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteOrder(${o.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
        }).join("");
    }

    /* ===========================
       VIEW DETAIL
    =========================== */

    async function viewOrderDetail(orderId) {
        // X√≥a modal c≈© n·∫øu c√≥
        let oldModal = document.getElementById('orderDetailModal');
        if (oldModal) {
            const modalInstance = bootstrap.Modal.getInstance(oldModal);
            if (modalInstance) modalInstance.dispose();
            oldModal.remove();
        }

        // X√≥a backdrop c≈©
        document.querySelectorAll(".modal-backdrop").forEach(e => e.remove());
        document.body.classList.remove("modal-open");
        document.body.style.removeProperty("overflow");
        document.body.style.removeProperty("padding-right");

        // T·∫°o modal m·ªõi v√† append v√†o body (kh√¥ng ph·∫£i section)
        const modalHTML = `
            <div class="modal fade" id="orderDetailModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title text-primary"><i class="bi bi-receipt"></i> Chi ti·∫øt ƒë∆°n h√†ng</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body" id="orderDetailContent">
                            <div class="text-center"><div class="spinner-border"></div></div>
                        </div>
                    </div>
                </div>
            </div>`;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        const modalEl = document.getElementById('orderDetailModal');
        const modal = new bootstrap.Modal(modalEl);
        const contentEl = document.getElementById('orderDetailContent');

        // Event cleanup khi ƒë√≥ng modal
        modalEl.addEventListener('hidden.bs.modal', function cleanup() {
            setTimeout(() => {
                document.querySelectorAll(".modal-backdrop").forEach(e => e.remove());
                document.body.classList.remove("modal-open");
                document.body.style.removeProperty("overflow");
                document.body.style.removeProperty("padding-right");
                modalEl.remove();
            }, 100);
        }, { once: true });

        modal.show();

        try {
            const res = await fetch(API_BASE + `/orders/${orderId}`);
            const o = await res.json();

            const mRes = await fetch(API_BASE + "/menu-items");
            const menuList = await mRes.json();

            let itemsHtml = '';
            if (o.items && o.items.length > 0) {
                itemsHtml = o.items.map(i => {
                    const m = menuList.find(x => x.id === i.menuItemId);
                    return `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><strong>${m?.name || "Kh√¥ng r√µ"}</strong> √ó ${i.quantity}</span>
                            <span class="badge bg-primary rounded-pill">${(m?.price || 0).toLocaleString()} ‚Ç´</span>
                        </li>`;
                }).join("");
            } else {
                itemsHtml = '<li class="list-group-item text-center text-muted">Kh√¥ng c√≥ m√≥n ƒÉn</li>';
            }

            contentEl.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <p class="mb-2"><strong>ID:</strong> <span class="text-muted">#${o.id}</span></p>
                        <p class="mb-2"><strong>Kh√°ch h√†ng:</strong> ${o.customerName}</p>
                        <p class="mb-2"><strong>ƒêi·ªán tho·∫°i:</strong> ${o.customerPhone}</p>
                        <p class="mb-2"><strong>ƒê·ªãa ch·ªâ:</strong> ${o.customerAddress}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-2"><strong>Nh√† h√†ng:</strong> ${o.restaurant?.name || 'N/A'}</p>
                        <p class="mb-2"><strong>Tr·∫°ng th√°i:</strong> <span class="badge bg-info">${o.status}</span></p>
                        <p class="mb-2"><strong>Th·ªùi gian:</strong> ${o.createdAt || 'N/A'}</p>
                    </div>
                </div>

                <hr class="my-3">

                <h6 class="text-primary mb-3"><i class="bi bi-bag-check"></i> Danh s√°ch m√≥n ƒÉn</h6>
                <ul class="list-group mb-3">${itemsHtml}</ul>

                <div class="text-end">
                    <h5 class="mb-0">T·ªïng c·ªông: <strong class="text-success">${(o.totalAmount || 0).toLocaleString()} ‚Ç´</strong></h5>
                </div>
            `;
        } catch (error) {
            console.error("L·ªói:", error);
            contentEl.innerHTML = '<div class="alert alert-danger">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu ƒë∆°n h√†ng</div>';
        }
    }

    /* ===========================
       DELETE ORDER
    =========================== */

    async function deleteOrder(id) {
        if (!confirm("X√≥a ƒë∆°n?")) return;
        await fetch(API_BASE + `/orders/${id}`, {method:"DELETE"});
        loadOrders();
    }

    /* ===========================
       INIT
    =========================== */

    (async ()=>{
        await loadUsers();
        await loadRestaurants();
        await loadMenuItems();
        await loadOrders();
    })();
</script>

</body>
</html>
