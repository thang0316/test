<h3>üë§ T√†i kho·∫£n</h3>

<div id="profileBox">ƒêang t·∫£i...</div>

<!-- Modal ƒë·ªïi m·∫≠t kh·∫©u -->
<div id="changePasswordModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ƒê·ªïi m·∫≠t kh·∫©u</h5>
                <button type="button" class="btn-close" onclick="closeChangePasswordModal()"></button>
            </div>
            <div class="modal-body">
                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i <span class="text-danger">*</span></label>
                        <input type="password" id="oldPassword" class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">M·∫≠t kh·∫©u m·ªõi <span class="text-danger">*</span></label>
                        <input type="password" id="newPassword" class="form-control" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi <span class="text-danger">*</span></label>
                        <input type="password" id="confirmPassword" class="form-control" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi" required>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="submitChangePassword()">ƒê·ªïi m·∫≠t kh·∫©u</button>
                    <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">H·ªßy</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    /* ============================
          LOAD USER FORMAT C≈®
    =============================== */
    function getUser(){
        return JSON.parse(localStorage.getItem("user") || "{}");
    }

    /* ============================
             LOAD PROFILE
    =============================== */
    async function loadProfile(){
        let user = getUser();

        if(!user.id){
            profileBox.innerHTML = "<p class='text-danger'>Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c ng∆∞·ªùi d√πng!</p>";
            return;
        }

        let r = await fetch(`/api/users/${user.id}`);
        let u = await r.json();

        profileBox.innerHTML = `
        <p><b>H·ªç t√™n:</b> ${u.firstName || ""} ${u.lastName || ""}</p>
        <p><b>Email:</b> ${u.email || "‚Äî"}</p>
        <p><b>S·ªë ƒëi·ªán tho·∫°i:</b> ${u.phone || "‚Äî"}</p>

        <div class="mt-3">
            <button class="btn btn-warning me-2" onclick="openChangePasswordModal()">
                ƒê·ªïi m·∫≠t kh·∫©u
            </button>
            <button class="btn btn-danger" onclick="logout()">
                ƒêƒÉng xu·∫•t
            </button>
        </div>
    `;
    }

    /* ============================
                LOGOUT
    =============================== */
    function logout(){
        localStorage.removeItem("user");
        localStorage.removeItem("cart");
        window.location.href = "/login";
    }

    /* ============================
          ƒê·ªîI M·∫¨T KH·∫®U - M·ªû MODAL
    =============================== */
    function openChangePasswordModal(){
        document.getElementById('changePasswordModal').style.display = 'block';
        document.getElementById('changePasswordModal').classList.add('show');
        document.body.classList.add('modal-open');
        
        // T·∫°o backdrop
        let backdrop = document.querySelector('.modal-backdrop');
        if(!backdrop){
            backdrop = document.createElement('div');
            backdrop.className = 'modal-backdrop fade show';
            document.body.appendChild(backdrop);
        }
    }

    /* ============================
        ƒê·ªîI M·∫¨T KH·∫®U - ƒê√ìNG MODAL
    =============================== */
    function closeChangePasswordModal(){
        document.getElementById('changePasswordModal').style.display = 'none';
        document.getElementById('changePasswordModal').classList.remove('show');
        document.body.classList.remove('modal-open');
        
        // X√≥a backdrop
        let backdrop = document.querySelector('.modal-backdrop');
        if(backdrop) backdrop.remove();
        
        // Reset form
        document.getElementById('changePasswordForm').reset();
    }

    /* ============================
      ƒê·ªîI M·∫¨T KH·∫®U - G·ª¨I Y√äU C·∫¶U
    =============================== */
    async function submitChangePassword(){
        let oldPassword = document.getElementById('oldPassword').value;
        let newPassword = document.getElementById('newPassword').value;
        let confirmPassword = document.getElementById('confirmPassword').value;
        
        // Validate
        if(!oldPassword){
            alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i!");
            return;
        }
        
        if(!newPassword){
            alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi!");
            return;
        }
        
        if(newPassword !== confirmPassword){
            alert("M·∫≠t kh·∫©u m·ªõi v√† x√°c nh·∫≠n kh√¥ng kh·ªõp!");
            return;
        }
        
        if(newPassword.length < 6){
            alert("M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!");
            return;
        }
        
        let user = getUser();
        let payload = {
            userId: user.id,
            oldPassword: oldPassword,
            newPassword: newPassword
        };
        
        try {
            const res = await fetch("/api/users/change-password", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });
            
            if(!res.ok){
                const error = await res.text();
                alert("L·ªói: " + error);
                return;
            }
            
            alert("ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!");
            closeChangePasswordModal();
        } catch(e){
            alert("L·ªói: " + e.message);
        }
    }

    loadProfile();
</script>
